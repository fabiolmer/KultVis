<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Leaflet Map - Gothenburg Cultural Activities</title>
    
    <script src="https://unpkg.com/shpjs@latest/dist/shp.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.osmbuildings.org/4.1.1/OSMBuildings.js"></script>

    <style>
        body, html { margin: 0; padding: 0; height: 100%; }
        #map { height: 100vh; width: 100vw; background: #ddd; }

        /* Widgets */
        #heading-widget {
            position: absolute; top: 20px; right: 20px;
            padding: 12px 20px; background: rgba(255, 255, 255, 0.9);
            border: 0.4px solid #333; border-radius: 5px;
            z-index: 1000; font-family: sans-serif;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3); pointer-events: none;
        }

        #activity-widget {
            position: absolute; top: 80px; right: 20px;
            z-index: 1000; width: 400px;
            display: flex; flex-direction: column; padding: 12px 20px;
            background: rgba(255, 255, 255, 0.9); border: 0.4px solid #333;
            border-radius: 5px; font-family: sans-serif;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            transition: width 0.3s ease;
        }

        #activity-widget.collapsed { width: auto; }

        #widget-header {
            display: flex; align-items: center; justify-content: space-between;
            cursor: pointer; user-select: none; gap: 12px;
        }

        #widget-text { font-weight: bold; white-space: nowrap; }

        #widget-toggle { font-size: 11px; color: #666; flex-shrink: 0; }

        #widget-body { margin-top: 10px; }
        #widget-body.hidden { display: none; }

        #widget-img { width: 100%; height: auto; border-radius: 4px; }

        #bar-legend {
            display: flex; flex-wrap: wrap; gap: 8px 16px;
            margin-top: 8px; font-size: 11px; font-family: sans-serif;
        }

        .bar-legend-item {
            display: flex; align-items: center; gap: 5px; white-space: nowrap;
        }

        .bar-legend-dot {
            width: 12px; height: 12px; border-radius: 2px; flex-shrink: 0;
        }

        #legend-widget {
            position: absolute; bottom: 30px; right: 20px;
            z-index: 1000; padding: 12px 16px;
            background: rgba(255, 255, 255, 0.9); border: 0.4px solid #333;
            border-radius: 5px; font-family: sans-serif; font-size: 13px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        #legend-widget h4 {
            margin: 0 0 10px 0; font-size: 13px; font-weight: bold;
        }

        .legend-item {
            display: flex; align-items: center; margin-bottom: 7px;
            cursor: pointer; user-select: none; transition: opacity 0.2s;
        }

        .legend-item:last-child { margin-bottom: 0; }

        .legend-item.disabled { opacity: 0.35; text-decoration: line-through; }

        .legend-dot {
            width: 14px; height: 14px; border-radius: 50%;
            border: 2px solid #fff; outline: 1px solid #aaa;
            margin-right: 8px; flex-shrink: 0;
        }

        .legend-divider {
            border: none; border-top: 0.4px solid #ccc;
            margin: 10px 0;
        }

        .legend-group-header {
            display: flex; align-items: center; gap: 6px;
            cursor: pointer; user-select: none; margin-bottom: 8px;
        }

        .legend-group-header.disabled h4 { opacity: 0.4; text-decoration: line-through; }
        .legend-group-header.disabled + #cultural-sites-group { opacity: 0.4; }

        .legend-category-title {
            font-weight: bold; font-size: 13px; margin-bottom: 6px;
        }

        .legend-subtitle {
            font-size: 11px; color: #555; margin-left: 22px; margin-bottom: 4px;
        }
    </style>
</head>
<body>

    <div id="map"></div>
    <div id="heading-widget">Gothenburg Film Studios</div>
    <div id="activity-widget" class="collapsed">
        <div id="widget-header">
            <div id="widget-text">Activities</div>
            <div id="widget-toggle">▼</div>
        </div>
        <div id="widget-body" class="hidden">
            <img id="widget-img" src="activities_bar_graph.png" alt="activities bar graph">
            <div id="bar-legend">
                <div class="bar-legend-item"><div class="bar-legend-dot" style="background:#7b2d8b;"></div> Production platform (48%)</div>
                <div class="bar-legend-item"><div class="bar-legend-dot" style="background:#d48fc8;"></div> Public activities (40%)</div>
                <div class="bar-legend-item"><div class="bar-legend-dot" style="background:#90d67a;"></div> Social and non-profit activities (8%)</div>
                <div class="bar-legend-item"><div class="bar-legend-dot" style="background:#2d6e3a;"></div> Education (4%)</div>
            </div>
        </div>
    </div>

    <div id="legend-widget">
        <div id="cultural-sites-header" class="legend-group-header">
            <input type="checkbox" id="cultural-sites-checkbox" checked style="cursor:pointer; margin:0; accent-color:#c8d8d8; width:14px; height:14px;">
            <h4 style="margin:0; display:inline; cursor:pointer;">Cultural Sites</h4>
        </div>
        <div id="cultural-sites-group">
            <div class="legend-item" data-category="Museum"><div class="legend-dot" style="background:#e74c3c;"></div> Museum</div>
            <div class="legend-item" data-category="Bibliotek"><div class="legend-dot" style="background:#3498db;"></div> Bibliotek</div>
            <div class="legend-item" data-category="Ateljé"><div class="legend-dot" style="background:#9b59b6;"></div> Ateljé</div>
            <div class="legend-item" data-category="Biograf"><div class="legend-dot" style="background:#f1c40f;"></div> Biograf</div>
            <div class="legend-item" data-category="Kulturhus"><div class="legend-dot" style="background:#2ecc71;"></div> Kulturhus</div>
            <div class="legend-item" data-category="default"><div class="legend-dot" style="background:#95a5a6;"></div> Other</div>
        </div>

        <hr class="legend-divider">

        <div id="relationscape-header" class="legend-group-header">
            <input type="checkbox" id="relationscape-checkbox" checked style="cursor:pointer; margin:0; accent-color:#c8d8d8; width:14px; height:14px;">
            <h4 style="margin:0; display:inline; cursor:pointer;">Relationscape Lindholmen</h4>
        </div>
        <div id="relationscape-group" style="max-height:300px; overflow-y:auto;">
            <div style="font-size:11px; color:#555; margin-bottom:6px;">Cultural value 1 and 2</div>
            <div class="legend-item rel-item" data-index="0"><div class="legend-dot" style="background:#ff6600;"></div> Karlatornet</div>
            <div class="legend-item rel-item" data-index="1"><div class="legend-dot" style="background:#ff6600;"></div> Backa teater</div>
            <div class="legend-item rel-item" data-index="2"><div class="legend-dot" style="background:#ff6600;"></div> Lindholmens manor</div>
            <div class="legend-item rel-item" data-index="3"><div class="legend-dot" style="background:#ff6600;"></div> Adolfs Hill</div>
            <div class="legend-item rel-item" data-index="4"><div class="legend-dot" style="background:#ff6600;"></div> Bostadsbebyggelsen</div>
            <div class="legend-item rel-item" data-index="5"><div class="legend-dot" style="background:#ff6600;"></div> Kuggen (Chalmers)</div>
            <div class="legend-item rel-item" data-index="6"><div class="legend-dot" style="background:#ff6600;"></div> The dome (temporary)</div>
            <div class="legend-item rel-item" data-index="7"><div class="legend-dot" style="background:#ff6600;"></div> Skatberget</div>
            <div class="legend-item rel-item" data-index="8"><div class="legend-dot" style="background:#ff6600;"></div> The dry dock facing the river</div>
            <div class="legend-item rel-item" data-index="9"><div class="legend-dot" style="background:#ff6600;"></div> Ancient traces and monuments</div>
            <div class="legend-item rel-item" data-index="10"><div class="legend-dot" style="background:#ff6600;"></div> The railway 'the harbourlink'</div>
            <div class="legend-item rel-item" data-index="11"><div class="legend-dot" style="background:#ff6600;"></div> Lundbyleden – traffic barrier</div>
            <div class="legend-item rel-item" data-index="12"><div class="legend-dot" style="background:#ff6600;"></div> The Propellerarea (Kvarteret Propellern)</div>
            <div class="legend-item rel-item" data-index="13"><div class="legend-dot" style="background:#ff6600;"></div> 28. Lundby Mekaniska verkstad</div>
            <div class="legend-item rel-item" data-index="14"><div class="legend-dot" style="background:#ff6600;"></div> 29. Göteborgs galvaniseringsfabrik (removed)</div>
            <div class="legend-item rel-item" data-index="15"><div class="legend-dot" style="background:#ff6600;"></div> 30. Lindholmen 735:491</div>
            <div class="legend-item rel-item" data-index="16"><div class="legend-dot" style="background:#ff6600;"></div> A</div>
            <div class="legend-item rel-item" data-index="17"><div class="legend-dot" style="background:#ff6600;"></div> B</div>
            <div class="legend-item rel-item" data-index="18"><div class="legend-dot" style="background:#ff6600;"></div> C</div>
            <div class="legend-item rel-item" data-index="19"><div class="legend-dot" style="background:#ff6600;"></div> D</div>
            <div class="legend-item rel-item" data-index="20"><div class="legend-dot" style="background:#ff6600;"></div> E</div>
            <div class="legend-item rel-item" data-index="21"><div class="legend-dot" style="background:#ff6600;"></div> F</div>
            <div class="legend-item rel-item" data-index="22"><div class="legend-dot" style="background:#ff6600;"></div> G</div>
            <div class="legend-item rel-item" data-index="23"><div class="legend-dot" style="background:#ff6600;"></div> H</div>
            <div class="legend-item rel-item" data-index="24"><div class="legend-dot" style="background:#ff6600;"></div> I</div>
            <div class="legend-item rel-item" data-index="25"><div class="legend-dot" style="background:#ff6600;"></div> Aftonstjärnan</div>
            <div class="legend-item rel-item" data-index="26"><div class="legend-dot" style="background:#ff6600;"></div> 1</div>
            <div class="legend-item rel-item" data-index="27"><div class="legend-dot" style="background:#ff6600;"></div> 2</div>
            <div class="legend-item rel-item" data-index="28"><div class="legend-dot" style="background:#ff6600;"></div> 3</div>
            <div class="legend-item rel-item" data-index="29"><div class="legend-dot" style="background:#ff6600;"></div> 4</div>
        </div>
    </div>

    <script>
        console.log("Script starting...");

        // 1. Initialize Map
        var map = L.map('map').setView([57.70979, 11.93344], 16);

        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; OpenStreetMap'
        }).addTo(map);

        // OSM 3D Buildings — using OSMBuildings v4 with Leaflet
        if (typeof OSMBuildings !== 'undefined') {
            try {
                var osmb = new OSMBuildings({
                    baseURL: 'https://cdn.osmbuildings.org/4.1.1'
                });
                osmb.addTo(map);
                osmb.addMapTiles('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png');
                osmb.addGeoJSONTiles('https://data.osmbuildings.org/0.2/anonymous/tile/{z}/{x}/{y}.json');
                console.log("OSMBuildings initialised.");
            } catch(e) {
                console.warn('OSMBuildings failed to initialise:', e);
            }
        } else {
            console.warn('OSMBuildings library not loaded.');
        }

        // 2. Define Colors
        const categoryColors = {
            "Museum": "#e74c3c",
            "Bibliotek": "#3498db",
            "Ateljé": "#9b59b6",
            "Biograf": "#f1c40f",
            "Kulturhus": "#2ecc71",
            "default": "#95a5a6"
        };

        // 3. Define Campus Buildings
        var campusData = [
            {
                name: "Studios building",
                points: [
                    [57.70951662524695, 11.931938382864644],
                    [57.70970176918331, 11.932277900706879],
                    [57.7094855863034,  11.932706919283135],
                    [57.709535974909755, 11.93279819983087],
                    [57.70938155799158, 11.933111596379405],
                    [57.709846432193814, 11.93392703594256],
                    [57.71024140803186, 11.933105511009643],
                    [57.71010932795221, 11.93287650459473],
                    [57.71013559888016, 11.932823692101266],
                    [57.71001636019332, 11.932439974500426],
                    [57.709693475936064, 11.93186314412037],
                    [57.70959299269569, 11.931838064537516],
                    [57.70951662524695, 11.931938382864644]
                ]
            },
            {
                name: "Rehearsal building",
                points: [
                    [57.70928745782078, 11.932208794353187],
                    [57.70902758335501, 11.932518927214943],
                    [57.70921998416708, 11.932836563290579],
                    [57.7093910062529,  11.932502670249931],
                    [57.70928745782078, 11.932208794353187]
                ]
            },
            {
                name: "Empty building",
                points: [
                    [57.70891610280418, 11.932665856538392],
                    [57.70869053782431, 11.93293811440671],
                    [57.708743539557986, 11.9330961624066],
                    [57.70896972050261, 11.932820443633346],
                    [57.70891610280418, 11.932665856538392]
                ]
            },
            {
                name: "Offices",
                points: [
                    [57.708124266181585, 11.933620724797635],
                    [57.70795570644813, 11.93382867907107],
                    [57.707956472630315, 11.934501303584142],
                    [57.70803845405169, 11.93464758865909],
                    [57.70815491332178, 11.93439087269374],
                    [57.708092852836245, 11.934268968464693],
                    [57.70809438519521, 11.933930504956834],
                    [57.708187858967875, 11.933797127388374],
                    [57.708124266181585, 11.933620724797635]
                ]
            },
            {
                name: "Deposit",
                points: [
                    [57.708321871241566, 11.933638322418574],
                    [57.70825181264752, 11.933778903815977],
                    [57.70823724044297, 11.933847096286001],
                    [57.708335322476074, 11.934025445819628],
                    [57.70843228331083, 11.933828212216696],
                    [57.708321871241566, 11.933638322418574]
                ]
            }
        ];

        // 4. Draw Campus Buildings — FIX: declare buildinglist, unified forEach, stop propagation
        var buildingList = [];

        campusData.forEach(function(building) {
            var poly = L.polygon(building.points, {
                color: 'red',
                weight: 2,
                fillOpacity: 0.2
            }).addTo(map);

            // FIX: stop propagation so map click doesn't immediately reset the fill
            poly.on('click', function(e) {
                L.DomEvent.stopPropagation(e);
                this.setStyle({ fillOpacity: 0.5 });
            });

            poly.bindPopup(building.name);

            // FIX: push into the declared array
            buildingList.push(poly);
        });

        // 5. When the MAP background is clicked: reset all buildings
        map.on('click', function() {
            buildingList.forEach(function(b) {
                b.setStyle({ fillOpacity: 0.2 });
            });
        });

        // 6. Category colours
        var categoryLayers   = {};
        var hiddenCategories = new Set();

        // 7. Custom Points Layer
        var customPoints = [
            { name: "Karlatornet", lat: 57.70993302217523, lng: 11.939144656326647 },
            { name: "Backa teater", lat: 57.7059134823545, lng: 11.935946002968043 },
            { name: "Lindholmens manor", lat: 57.70822191757826, lng: 11.932127495719401 },
            { name: "Adolfs Hill", lat: 57.70874624233934, lng: 11.931688165065507 },
            { name: "Bostadsbebyggelsen", lat: 57.70403715038053, lng: 11.92922023307963 },
            { name: "Kuggen (Chalmers)", lat: 57.706705768556226, lng: 11.938823849178842 },
            { name: "The dome (temporary)", lat: 57.7069678751202, lng: 11.938024547056298 },
            { name: "Skatberget", lat: 57.703394567613806, lng: 11.932637758777398 },
            { name: "The dry dock facing the river", lat: 57.70390322289196, lng: 11.931243230625997 },
            { name: "Ancient traces and monuments", lat: 57.709106700082025, lng: 11.931282345782982 },
            { name: "The railway 'the harbourlink'", lat: 57.711460035312754, lng: 11.933624363134244 },
            { name: "Lundbyleden – traffic barrier", lat: 57.71194583240717, lng: 11.933995956694147 },
            { name: "The Propellerarea (Kvarteret Propellern)", lat: 57.709876323746826, lng: 11.933281689779417 },
            { name: "28. Lundby Mekaniska verkstad – KV-konstskola & Balettakademien Göteborg", lat: 57.70918449081427, lng: 11.936593557667631 },
            { name: "29. Göteborgs galvaniseringsfabrik (removed)", lat: 57.7103486083178, lng: 11.938426305917357 },
            { name: "30. Lindholmen 735:491", lat: 57.70800, lng: 11.93419 },
            { name: "A", lat: 57.70882724595256, lng: 11.931242712062327 },
            { name: "B", lat: 57.706838332579316, lng: 11.927863128855241 },
            { name: "C", lat: 57.70655370905854, lng: 11.931877856803176 },
            { name: "D", lat: 57.704201539462396, lng: 11.929593145840556 },
            { name: "E", lat: 57.70418782373976, lng: 11.933212744107175 },
            { name: "F", lat: 57.70705429686395, lng: 11.93738426693218 },
            { name: "G", lat: 57.707081726132756, lng: 11.938334090590796 },
            { name: "H", lat: 57.70867258817404, lng: 11.940605966098568 },
            { name: "I", lat: 57.70904286500106, lng: 11.93725591238372 },
            { name: "Aftonstjärnan", lat: 57.70701587605392, lng: 11.932744845029957 },
            { name: "1", lat: 57.703525358475936, lng: 11.934794455961411 },
            { name: "2", lat: 57.70589850286558, lng: 11.93873193861855 },
            { name: "3", lat: 57.7063683140276, lng: 11.946702964372975 },
            { name: "4", lat: 57.7060645183475, lng: 11.9493100717401 }
        ];

        var customMarkers = [];
        customPoints.forEach(function(point) {
            var marker = L.circleMarker([point.lat, point.lng], {
                radius: 9, fillColor: "#ff6600",
                color: "#fff", weight: 2, fillOpacity: 1
            }).bindPopup("<strong>" + point.name + "</strong>").addTo(map);
            customMarkers.push(marker);
        });

        // 8. Load Shapefile
        async function loadCulturalData() {
            try {
                var geojsonData = await shp("kulturverksamheter_utdrag_GBG_251212.zip");
                console.log("Shapefile data received:", geojsonData);

                // shp() can return a single FeatureCollection or an array — handle both
                var collections = Array.isArray(geojsonData) ? geojsonData : [geojsonData];

                collections.forEach(function(collection) {
                    L.geoJSON(collection, {
                        pointToLayer: function(feature, latlng) {
                            var props    = feature.properties;
                            var category = props.Kategori || props.Typ || "";
                            var colorKey = categoryColors[category] ? category : "default";
                            var color    = categoryColors[colorKey];
                            var marker   = L.circleMarker(latlng, {
                                radius: 8, fillColor: color,
                                color: "#fff", weight: 2, fillOpacity: 0.9
                            });
                            if (!categoryLayers[colorKey]) categoryLayers[colorKey] = [];
                            categoryLayers[colorKey].push(marker);
                            return marker;
                        },
                        onEachFeature: function(feature, layer) {
                            layer.bindPopup(
                                "<strong>" + (feature.properties.Kategori || "Cultural Site") + "</strong>"
                            );
                        }
                    }).addTo(map);
                });

                console.log("Shapefile loaded successfully! Categories found:", Object.keys(categoryLayers));
            } catch (err) {
                console.error("Shapefile Error:", err);
            }
        }
        loadCulturalData();

        // 9. Activity widget collapse (starts collapsed)
        document.getElementById('widget-header').addEventListener('click', function() {
            var body      = document.getElementById('widget-body');
            var widget    = document.getElementById('activity-widget');
            var toggle    = document.getElementById('widget-toggle');
            var nowHidden = body.classList.toggle('hidden');
            widget.classList.toggle('collapsed', nowHidden);
            toggle.textContent = nowHidden ? '▼' : '▲';
        });

        // 10. Cultural Sites group toggle
        function toggleCulturalSites(visible) {
            document.getElementById('cultural-sites-header').classList.toggle('disabled', !visible);
            Object.values(categoryLayers).forEach(function(layers) {
                layers.forEach(function(l) {
                    l.setStyle({ fillOpacity: visible ? 0.9 : 0, opacity: visible ? 1 : 0 });
                });
            });
            if (visible) {
                document.querySelectorAll('#cultural-sites-group .legend-item').forEach(function(item) {
                    item.classList.remove('disabled');
                });
                hiddenCategories.clear();
            }
        }

        document.getElementById('cultural-sites-header').addEventListener('click', function(e) {
            if (e.target.id === 'cultural-sites-checkbox') return;
            var cb = document.getElementById('cultural-sites-checkbox');
            cb.checked = !cb.checked;
            toggleCulturalSites(cb.checked);
        });

        document.getElementById('cultural-sites-checkbox').addEventListener('change', function() {
            toggleCulturalSites(this.checked);
        });

        // Individual Cultural Sites category toggle
        document.querySelectorAll('#cultural-sites-group .legend-item').forEach(function(item) {
            item.addEventListener('click', function() {
                var cat    = this.dataset.category;
                var layers = categoryLayers[cat];
                if (hiddenCategories.has(cat)) {
                    hiddenCategories.delete(cat);
                    this.classList.remove('disabled');
                    if (layers) layers.forEach(function(l) { l.setStyle({ fillOpacity: 0.9, opacity: 1 }); });
                } else {
                    hiddenCategories.add(cat);
                    this.classList.add('disabled');
                    if (layers) layers.forEach(function(l) { l.setStyle({ fillOpacity: 0, opacity: 0 }); });
                }
            });
        });

        // 11. Relationscape group toggle
        function toggleRelationscape(visible) {
            document.getElementById('relationscape-header').classList.toggle('disabled', !visible);
            customMarkers.forEach(function(m, idx) {
                var item = document.querySelector('.rel-item[data-index="' + idx + '"]');
                var indivHidden = item && item.classList.contains('disabled');
                m.setStyle({
                    fillOpacity: (!visible || indivHidden) ? 0 : 1,
                    opacity:     (!visible || indivHidden) ? 0 : 1
                });
            });
            document.querySelectorAll('#relationscape-group .rel-item').forEach(function(item) {
                item.classList.toggle('disabled', !visible);
            });
        }

        document.getElementById('relationscape-header').addEventListener('click', function(e) {
            if (e.target.id === 'relationscape-checkbox') return;
            var cb = document.getElementById('relationscape-checkbox');
            cb.checked = !cb.checked;
            toggleRelationscape(cb.checked);
        });

        document.getElementById('relationscape-checkbox').addEventListener('change', function() {
            toggleRelationscape(this.checked);
        });

        // Individual Relationscape point toggle
        document.querySelectorAll('.rel-item').forEach(function(item) {
            item.addEventListener('click', function() {
                var idx          = parseInt(this.dataset.index);
                var marker       = customMarkers[idx];
                var isNowDisabled = this.classList.toggle('disabled');
                marker.setStyle({
                    fillOpacity: isNowDisabled ? 0 : 1,
                    opacity:     isNowDisabled ? 0 : 1
                });
            });
        });

    </script>
</body>
</html>
